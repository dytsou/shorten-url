<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Shortener</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 50px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Authentication Popup Styles */
        .auth-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .auth-popup.show {
            opacity: 1;
            visibility: visible;
        }

        .auth-popup-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .auth-popup.show .auth-popup-content {
            transform: scale(1);
        }

        .auth-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .auth-popup-title {
            font-size: 1.5em;
            color: #333;
            margin: 0;
        }

        .auth-popup-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .auth-popup-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .auth-section {
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 20px;
            background: #f8f9fa;
        }

        .auth-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 500;
        }

        .auth-status.not-authenticated {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .auth-status.authenticated {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .auth-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .auth-btn {
            flex: 1;
            min-width: 140px;
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .fingerprint-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .fingerprint-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .password-btn {
            background: linear-gradient(45deg, #ffc107, #ff8c00);
            color: white;
        }

        .password-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 193, 7, 0.3);
        }

        .logout-btn {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
        }

        .password-form {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
            display: none;
        }

        .password-form.show {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="url"],
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="url"]:focus,
        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .custom-slug-group {
            position: relative;
        }

        .url-prefix {
            display: block;
            padding: 6px 10px;
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-bottom: none;
            border-radius: 10px 10px 0 0;
            color: #666;
            font-size: 12px;
            font-weight: 400;
            margin-bottom: 0;
            word-break: break-all;
        }

        .custom-slug-input {
            border-radius: 0 0 10px 10px !important;
            border-top: none !important;
            padding: 15px !important;
        }

        .custom-slug-input:focus+.url-prefix,
        .custom-slug-input:focus~.url-prefix,
        .custom-slug-group:focus-within .url-prefix {
            border-color: #667eea;
            background: #f0f3ff;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eeac3, #764ba2ba);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .button-group button {
            width: 100%;
        }

        .result {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: none;
        }

        .result.show {
            display: block;
        }

        .result h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .shortened-url {
            display: flex;
            align-items: stretch;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .shortened-url input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            font-size: 14px;
        }

        .copy-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }

        .copy-btn:hover {
            background: #218838;
        }

        .goto-btn {
            background: linear-gradient(45deg, #17a2b8, #138496);
            margin-top: 15px;
        }

        .goto-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(23, 162, 184, 0.3);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .message {
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b5d3ff;
        }

        @media (max-width: 768px) {
            .container {
                margin: 20px auto;
                padding: 20px;
            }

            .auth-popup-content {
                padding: 20px;
                margin: 20px;
            }

            .auth-buttons {
                flex-direction: column;
            }

            .auth-btn {
                min-width: auto;
            }

            .shortened-url {
                flex-direction: column;
            }

            .shortened-url input {
                min-width: auto;
            }

            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>🔗 URL Shortener</h1>

        <form id="urlForm">
            <div class="form-group">
                <label for="longUrl">Enter your long URL:</label>
                <input type="url" id="longUrl" name="longUrl" required
                    placeholder="https://example.com/very-long-url-here">
            </div>

            <div class="form-group">
                <label for="customSlug">Custom short URL (optional):</label>
                <div class="custom-slug-group">
                    <span class="url-prefix" id="urlPrefix"></span>
                    <input type="text" id="customSlug" name="customSlug" class="custom-slug-input"
                        placeholder="my-custom-link" pattern="^[a-zA-Z0-9._-]+$">
                </div>
            </div>

            <div class="button-group">
                <button type="submit">🚀 Shorten URL</button>
                <button type="button" class="goto-btn" onclick="shortenAndVisit()">🔗 Shorten URL and Visit</button>
            </div>
        </form>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            Processing...
        </div>

        <div id="errorMessage" class="message error"></div>
        <div id="successMessage" class="message success"></div>
        <div id="infoMessage" class="message info"></div>

        <div id="result" class="result">
            <h3>✅ URL Shortened Successfully!</h3>
            <div class="shortened-url">
                <input type="text" id="shortUrlOutput" readonly>
                <button class="copy-btn" onclick="copyToClipboard()">📋 Copy</button>
            </div>
        </div>
    </div>

    <!-- Authentication Popup -->
    <div id="authPopup" class="auth-popup">
        <div class="auth-popup-content">
            <div class="auth-popup-header">
                <h2 class="auth-popup-title">🔐 Authentication Required</h2>
                <button class="auth-popup-close" onclick="closeAuthPopup()">&times;</button>
            </div>

            <div class="auth-section">
                <h3>🔒 Secure Access</h3>
                <div id="authStatus" class="auth-status not-authenticated">
                    <span>🔓</span>
                    <span>Please authenticate to continue</span>
                </div>

                <div class="auth-buttons">
                    <button class="auth-btn fingerprint-btn" onclick="authenticateWithFingerprint()">
                        🖐️ Fingerprint
                    </button>
                    <button class="auth-btn password-btn" onclick="showAuthPasswordForm()">
                        🔑 Password
                    </button>
                </div>

                <div id="passwordForm" class="password-form">
                    <div class="form-group">
                        <label for="authPassword">Password:</label>
                        <input type="password" id="authPassword" placeholder="Enter your password">
                    </div>
                    <button type="button" class="auth-btn password-btn" onclick="authenticateWithPassword()">
                        🔐 Authenticate
                    </button>
                </div>
            </div>

            <div id="authLoading" class="loading">
                <div class="spinner"></div>
                Authenticating...
            </div>

            <div id="authErrorMessage" class="message error"></div>
            <div id="authSuccessMessage" class="message success"></div>
        </div>
    </div>

    <script>
        // Global variables
        let sessionToken = null;
        let isAuthenticated = false;
        let pendingAction = null; // 'shorten' or 'shortenAndVisit'
        let pendingData = null;

        // Set the URL prefix on page load
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('urlPrefix').textContent = window.location.origin + '/';
            checkAuthStatus();
        });

        // Check authentication status
        function checkAuthStatus() {
            const storedToken = localStorage.getItem('sessionToken');
            if (storedToken) {
                sessionToken = storedToken;
                isAuthenticated = true;
            }
        }

        // Show authentication popup
        function showAuthPopup() {
            document.getElementById('authPopup').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // Close authentication popup
        function closeAuthPopup() {
            document.getElementById('authPopup').classList.remove('show');
            document.body.style.overflow = 'auto';
            hideAuthMessages();
            hideAuthPasswordForm();
            pendingAction = null;
            pendingData = null;
        }

        // Handle escape key to close popup
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && document.getElementById('authPopup').classList.contains('show')) {
                closeAuthPopup();
            }
        });

        // Close popup when clicking backdrop
        document.getElementById('authPopup').addEventListener('click', function (e) {
            if (e.target === this) {
                closeAuthPopup();
            }
        });

        // Authentication functions
        function showAuthLoading() {
            document.getElementById('authLoading').classList.add('show');
        }

        function hideAuthLoading() {
            document.getElementById('authLoading').classList.remove('show');
        }

        function showAuthError(message) {
            hideAuthMessages();
            const errorEl = document.getElementById('authErrorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function showAuthSuccess(message) {
            hideAuthMessages();
            const successEl = document.getElementById('authSuccessMessage');
            successEl.textContent = message;
            successEl.classList.add('show');
        }

        function hideAuthMessages() {
            document.getElementById('authErrorMessage').classList.remove('show');
            document.getElementById('authSuccessMessage').classList.remove('show');
        }

        async function authenticateWithFingerprint() {
            if (!navigator.credentials || !navigator.credentials.create) {
                showAuthError('Fingerprint authentication not supported in this browser');
                showAuthPasswordForm();
                return;
            }

            try {
                showAuthLoading();
                hideAuthMessages();

                // Get authentication challenge from server
                const challengeResponse = await fetch('/auth/challenge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ type: 'fingerprint' })
                });

                const challengeData = await challengeResponse.json();

                if (!challengeData.success) {
                    throw new Error(challengeData.message || 'Failed to get authentication challenge');
                }

                // Create credential request
                const credential = await navigator.credentials.get({
                    publicKey: {
                        challenge: new Uint8Array(challengeData.challenge),
                        allowCredentials: [],
                        timeout: 60000
                    }
                });

                // Send credential to server for verification
                const response = await fetch('/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'fingerprint',
                        credential: {
                            id: Array.from(new Uint8Array(credential.rawId), b => b.toString(16).padStart(2, '0')).join(''),
                            response: credential.response
                        }
                    })
                });

                const result = await response.json();
                hideAuthLoading();

                if (result.success) {
                    sessionToken = result.sessionToken;
                    isAuthenticated = true;
                    localStorage.setItem('sessionToken', sessionToken);
                    showAuthSuccess('Fingerprint authentication successful!');

                    setTimeout(() => {
                        closeAuthPopup();
                        proceedWithPendingAction();
                    }, 1000);
                } else {
                    showAuthError(result.message || 'Fingerprint authentication failed. Trying password fallback...');
                    showAuthPasswordForm();
                }

            } catch (error) {
                hideAuthLoading();
                console.error('Fingerprint authentication error:', error);
                showAuthError('Fingerprint authentication failed. Please try password authentication.');
                showAuthPasswordForm();
            }
        }

        function showAuthPasswordForm() {
            document.getElementById('passwordForm').classList.add('show');
        }

        function hideAuthPasswordForm() {
            document.getElementById('passwordForm').classList.remove('show');
            document.getElementById('authPassword').value = '';
        }

        async function authenticateWithPassword() {
            const password = document.getElementById('authPassword').value;

            if (!password) {
                showAuthError('Please enter a password');
                return;
            }

            try {
                showAuthLoading();
                hideAuthMessages();

                const response = await fetch('/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'password',
                        password: password
                    })
                });

                const result = await response.json();
                hideAuthLoading();

                if (result.success) {
                    sessionToken = result.sessionToken;
                    isAuthenticated = true;
                    localStorage.setItem('sessionToken', sessionToken);
                    showAuthSuccess('Password authentication successful!');

                    setTimeout(() => {
                        closeAuthPopup();
                        proceedWithPendingAction();
                    }, 1000);
                } else {
                    showAuthError(result.message || 'Password authentication failed');
                }

            } catch (error) {
                hideAuthLoading();
                console.error('Password authentication error:', error);
                showAuthError('Authentication failed. Please try again.');
            }
        }

        // Proceed with pending action after authentication
        function proceedWithPendingAction() {
            if (pendingAction === 'shorten') {
                performUrlShortening(pendingData);
            } else if (pendingAction === 'shortenAndVisit') {
                performShortenAndVisit(pendingData);
            }
        }

        // Main page functions
        function showLoading() {
            document.getElementById('loading').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        function showError(message) {
            hideMessages();
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function showSuccess(message) {
            hideMessages();
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.classList.add('show');
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.remove('show');
            document.getElementById('successMessage').classList.remove('show');
            document.getElementById('infoMessage').classList.remove('show');
        }

        // Enhanced form submission with authentication check
        document.getElementById('urlForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const longUrl = document.getElementById('longUrl').value;
            const customSlug = document.getElementById('customSlug').value;

            if (!isAuthenticated) {
                // Store pending action and show auth popup
                pendingAction = 'shorten';
                pendingData = { longUrl, customSlug };
                showAuthPopup();
                return;
            }

            // Proceed with URL shortening
            performUrlShortening({ longUrl, customSlug });
        });

        // Perform URL shortening
        async function performUrlShortening(data) {
            const { longUrl, customSlug } = data;

            // Show loading, hide previous results
            showLoading();
            document.getElementById('result').classList.remove('show');
            hideMessages();

            try {
                // Prepare the request payload
                const payload = {
                    url: longUrl,
                    sessionToken: sessionToken
                };

                // Add custom slug if provided
                if (customSlug && customSlug.trim() !== '') {
                    payload.custom_slug = customSlug.trim();
                }

                // Make API call to your Cloudflare Worker
                const response = await fetch(window.location.origin, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                hideLoading();

                if (response.ok && result.status === 200) {
                    // Show success result
                    const shortUrl = window.location.origin + (result.key.startsWith('/') ? result.key : '/' + result.key);
                    document.getElementById('shortUrlOutput').value = shortUrl;
                    document.getElementById('result').classList.add('show');

                    // Reset form
                    document.getElementById('urlForm').reset();
                    showSuccess('URL shortened successfully!');
                } else if (result.status === 401) {
                    // Session expired, need to re-authenticate
                    sessionToken = null;
                    isAuthenticated = false;
                    localStorage.removeItem('sessionToken');
                    showError('Session expired. Please try again.');
                } else {
                    // Show error
                    const errorMsg = result.message || 'An error occurred while shortening the URL.';
                    showError(errorMsg);
                }

            } catch (error) {
                hideLoading();
                showError('Network error. Please try again.');
            }
        }

        // Shorten URL and Visit function
        async function shortenAndVisit() {
            const longUrl = document.getElementById('longUrl').value;
            const customSlug = document.getElementById('customSlug').value;

            // Validate URL input
            if (!longUrl) {
                showError('Please enter a URL first');
                return;
            }

            if (!isAuthenticated) {
                // Store pending action and show auth popup
                pendingAction = 'shortenAndVisit';
                pendingData = { longUrl, customSlug };
                showAuthPopup();
                return;
            }

            // Proceed with shorten and visit
            performShortenAndVisit({ longUrl, customSlug });
        }

        // Perform shorten and visit
        async function performShortenAndVisit(data) {
            const { longUrl, customSlug } = data;
            const gotoBtn = document.querySelector('.goto-btn');
            const originalText = gotoBtn.textContent;

            // Show processing state
            gotoBtn.textContent = 'Processing...';
            gotoBtn.disabled = true;

            try {
                // Prepare the request payload
                const payload = {
                    url: longUrl,
                    sessionToken: sessionToken
                };

                // Add custom slug if provided
                if (customSlug && customSlug.trim() !== '') {
                    payload.custom_slug = customSlug.trim();
                }

                // Make API call to shorten URL
                const response = await fetch(window.location.origin, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.status === 200) {
                    // Visit the shortened URL
                    const shortUrl = window.location.origin + (result.key.startsWith('/') ? result.key : '/' + result.key);

                    // Reset form
                    document.getElementById('urlForm').reset();

                    // Open the shortened URL
                    window.open(shortUrl, '_blank');

                    showSuccess('URL shortened and opened successfully!');
                } else if (result.status === 401) {
                    // Session expired, need to re-authenticate
                    sessionToken = null;
                    isAuthenticated = false;
                    localStorage.removeItem('sessionToken');
                    showError('Session expired. Please try again.');
                } else {
                    // Show error
                    const errorMsg = result.message || 'An error occurred while shortening the URL.';
                    showError(errorMsg);
                }

            } catch (error) {
                showError('Network error. Please try again.');
            } finally {
                // Reset button state
                gotoBtn.textContent = originalText;
                gotoBtn.disabled = false;
            }
        }

        // Copy to clipboard function
        function copyToClipboard() {
            const shortUrlOutput = document.getElementById('shortUrlOutput');
            shortUrlOutput.select();
            shortUrlOutput.setSelectionRange(0, 99999);
            document.execCommand('copy');

            const copyBtn = document.querySelector('.copy-btn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = '✅ Copied!';
            copyBtn.style.background = '#28a745';

            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.style.background = '#28a745';
            }, 2000);
        }
    </script>
</body>

</html>